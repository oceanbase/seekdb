#owner: fenggu.yh
#owner group: storage
#tags: column_group

connect (sys_conn,$OBMYSQL_MS0,admin,$OBMYSQL_PWD,oceanbase,$OBMYSQL_PORT);
connection sys_conn;

--disable_query_log
--disable_warnings
set @@recyclebin = off;
drop table if exists cg_tt1;
drop table if exists cg_tt2;
--enable_warnings
--enable_query_log

create table cg_tt1(a int, b int, c int, primary key(a)) with column group (all columns, each column);
create index idx_cg_tt1 on cg_tt1(b);
create table cg_tt2(d int, e int);
alter table cg_tt1 modify column c varchar(20);
alter table cg_tt1 drop column c;

let $cg_tt1_table_id= query_get_value(select table_id from __all_virtual_table where table_name='cg_tt1', table_id, 1);
let $cg_tt2_table_id= query_get_value(select table_id from __all_virtual_table where table_name='cg_tt2', table_id, 1);

## In cg_tt1 table schema, there exists 4 column_group: __cg_default, __cg_all, __cg_a, __cg_b
let $cg_tt1_cg_cnt = query_get_value(select count(*) as cg_cnt from __all_column_group where table_id=$cg_tt1_table_id, cg_cnt, 1);
if ($cg_tt1_cg_cnt != 5)
{
    --echo unexpected column_group count of table cg_tt1, real value is $cg_tt1_cg_cnt
}
## cg_tt1 default_type column_group will have none column_id mapping, cuz it has all_type & each_type column_group
let $cg_tt1_default_cg_id = query_get_value(select column_group_id from __all_column_group where table_id=$cg_tt1_table_id and column_group_name='__co_default', column_group_id, 1);
let $cg_tt1_column_id_cnt = query_get_value(select count(*) as mapping_cnt from __all_column_group_mapping where table_id=$cg_tt1_table_id and column_group_id=$cg_tt1_default_cg_id, mapping_cnt, 1);
if ($cg_tt1_column_id_cnt != 0)
{
    --echo unexpected column_group mapping count of table cg_tt1, real value is $cg_tt1_column_id_cnt;
}

## In cg_tt2 table schema, there exists only 1 column_group: __co_default
let $cg_tt2_cg_cnt = query_get_value(select count(*) as cg_cnt from __all_column_group where table_id=$cg_tt2_table_id, cg_cnt, 1);
if ($cg_tt2_cg_cnt != 1)
{
    --echo unexpected column_group count of table cg_tt2, real value is $cg_tt2_cg_cnt
}
## cg_tt2 default_type column_group will have 3 column_id mapping, include d, e, pk_increment
let $cg_tt2_default_cg_id = query_get_value(select column_group_id from __all_column_group where table_id=$cg_tt2_table_id and column_group_name='__co_default', column_group_id, 1);
let $cg_tt2_column_id_cnt = query_get_value(select count(*) as mapping_cnt from __all_column_group_mapping where table_id=$cg_tt2_table_id and column_group_id=$cg_tt2_default_cg_id, mapping_cnt, 1);
if ($cg_tt2_column_id_cnt != 3)
{
    --echo unexpected column_group mapping count of table cg_tt2, real value is $cg_tt2_column_id_cnt
}

drop table cg_tt1;
drop table cg_tt2;

--disable_query_log
set @@recyclebin = on;
--enable_query_log
